# WASM Component Setup for Frontend

This document explains how the WASM component transpilation is integrated into the frontend build process.

## Overview

The frontend automatically transpiles the WASM component (`../bg/bin/triangle.wasm`) into browser-compatible JavaScript before starting the dev server or building. This is handled by a custom Vite plugin.

## How It Works

### 1. Automatic Transpilation

The `vite-plugin-jco-transpile.ts` plugin runs `jco transpile` automatically when you:
- Run `npm run dev` (development server)
- Run `npm run build` (production build)

The plugin:
- Checks if the WASM file exists
- Creates the `src/wasm/generated` output directory if needed
- Runs the full `jco transpile` command with all necessary mappings
- Copies `src/lib/gfx.js` to the output directory (needed for relative imports in generated code)

### 2. Rolldown-Vite External Configuration

In `vite.config.ts`, we configure `rolldown-vite` to treat WASI interfaces as external:

```typescript
build: {
  rollupOptions: {
    external: [
      'wasi:webgpu/webgpu@0.0.1',
      'wasi:surface/surface@0.0.1',
      'wasi:graphics-context/graphics-context@0.0.1',
      'wasi:frame-buffer/frame-buffer@0.0.1',
      /^https:\/\/cdn\.jsdelivr\.net\/npm\/@bytecodealliance\/preview2-shim/,
    ],
  },
}
```

**Why this is necessary:**

1. **Component Model Imports**: The transpiled JavaScript from `jco` will import these WASI interfaces (e.g., `import 'wasi:webgpu/webgpu@0.0.1'`)

2. **Runtime Resolution**: These interfaces are provided at runtime by:
   - `gfx.js` (for WebGPU, surface, graphics-context, frame-buffer)
   - CDN-hosted WASI shims (for filesystem, clocks, io, random, cli, sockets)

3. **No Bundling**: Rolldown should NOT bundle these because:
   - They're not npm packages
   - They're provided by the mappings configured in `jco transpile`
   - The mappings resolve to either local files (`./gfx.js`) or CDN URLs

4. **External Resolution**: By marking them as `external`, rolldown:
   - Skips bundling them
   - Leaves the import statements as-is
   - Expects them to be resolved at runtime through the mappings

## File Structure

```
frontend/
├── vite-plugin-jco-transpile.ts  # Plugin that runs jco transpile
├── vite.config.ts                 # Vite config with external settings
├── src/
│   ├── lib/
│   │   └── gfx.js                 # Source: WebGPU/WASI bindings
│   └── wasm/
│       └── generated/             # Generated by jco transpile
│           ├── triangle.js         # Transpiled JavaScript bindings
│           ├── triangle.d.ts       # TypeScript definitions
│           ├── triangle.core.wasm  # Processed WASM
│           ├── gfx.js              # Copied from src/lib/ (for relative imports)
│           └── interfaces/         # Generated interface definitions
└── ...
```

**Note**: `src/wasm/generated/` is in `.gitignore` as it's regenerated on each build.

## Usage

Just run your normal commands:

```bash
npm run dev    # Automatically transpiles, then starts dev server
npm run build  # Automatically transpiles, then builds
```

The transpilation happens automatically - you don't need to run `jco transpile` manually.

## Troubleshooting

### jco not found
If you see an error about `jco` not being found:
- Make sure `@bytecodealliance/jco` is installed: `npm install -g @bytecodealliance/jco`
- Or use npx: The plugin can be updated to use `npx jco` instead

### WASM file not found
If the WASM file is missing:
- Make sure `../bg/bin/triangle.wasm` exists
- Build the WASM component first in the `bg/` directory

### Import errors in browser
If you see import errors for WASI interfaces:
- Check that `gfx.js` is accessible in `src/wasm/generated/`
- Verify the external configuration in `vite.config.ts` matches the interfaces used
- Check browser console for specific import errors
- Ensure `src/lib/gfx.js` exists (source file)

## Relationship to Component Model

The WASM Component Model uses:
- **WIT (WebAssembly Interface Types)**: Defines the interfaces
- **Component imports**: Interfaces like `wasi:webgpu/webgpu` that need implementations
- **Runtime mappings**: The `--map` flags tell `jco` where to find implementations

Rolldown's `external` configuration ensures these component imports remain as external imports (not bundled), so they can be resolved at runtime through the mappings.

